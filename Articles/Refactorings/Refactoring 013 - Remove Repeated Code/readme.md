# Refactoring 013 - Remove Repeated Code
            
![Refactoring 013 - Remove Repeated Code](Refactoring%20013%20-%20Remove%20Repeated%20Code.jpg)

*Don't Repeat Yourself*

> TL;DR: How to remove repeated code	     

# Problems Addressed

- Don't Repeat Yourself

- Copy/Paste Programming

- No single source of truth

# Related Code Smells

[Code Smell 46 - Repeated Code](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Code%20Smells/Code%20Smell%2046%20-%20Repeated%20Code/readme.md)

[Code Smell 11 - Subclassification for Code Reuse](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Code%20Smells/Code%20Smell%2011%20-%20Subclassification%20for%20Code%20Reuse/readme.md)

[Code Smell 232 - Reusable Code](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Code%20Smells/Code%20Smell%20232%20-%20Reusable%20Code/readme.md)

# Context

Duplicated code is a severe code smell, it leads to maintainability problems and ripple effects.

Start by identifying behavior duplication.

Once you find it, you will extract it into reusable functions or classes, reducing redundancy, creating a single source of truth, and simplifying future updates.

Behavior duplication is a sign of a missing abstraction you need to create. 

As always, you should search for it in the real world.

Refactoring isn't a one-time event; it's an ongoing process that should be integrated into your development workflow. 

# Steps

1.  Make a contextual copy of the repeated code

2. Parametrize what is different

3. Invoke the abstraction
 
4. Find a real-world metaphor for the abstraction

*(This is the harder and not mechanical step)*

# Sample Code

*(This is actual code generated by Google Gemini)*

See a complete explanation in this [talk](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Artificial%20Intelligence/Clean%20Code%20With%20AI/readme.md)

## Before

[Gist Url]: # (https://gist.github.com/mcsee/4faa40928a8ac53cca2d1381c8a2e1c2)

```php
<?php

class AccessControlPanel {

  private $users = [];

  public function createRegularUser($username, $password, $email) {
    $user = [
      "username" => $username,
      "email" => $email,
      "type" => $this->regularUserRole(),
      "creationDate" => $this->timeSource->currentTimestamp(),
      "needsToChangePassword" => $this->needsToChangePassword(),
      "loginPolicy" => $this->userLoginPolicy()
    ]
    $this->users[] = $user;
    $this->addCreationToJournal($user);
  }
  
   public function createAdminUser($username, $password, $email) {
    $user = [
      "username" => $username,
      "email" => $email,
      "type" => $this->regularUserRole(),
      "creationDate" => $this->timeSource->currentTimestamp(),
      "needsToChangePassword" => $this->needsToChangePassword(),
      "loginPolicy" => $this->adminUserLoginPolicy()
    ]
    $this->users[] = $user;
    $this->addCreationToJournal($user);
    return $user;
  }
} 

?>
```

## After

[Gist Url]: # (https://gist.github.com/mcsee/9c90a11f4488bfbeded051d6e1be596a)

```php
<?php

class AccessControlPanel {

  private $users = [];

  // 1.  Make a contextual copy of the repeated code
  
  private function createUser(
     $username, 
     $password,
     $email, 
     $role, 
     $loginPolicy) {
    $user = [
      "username" => $username,
      "email" => $email,
      "type" => $role,
      "creationDate" => $this->timeSource->currentTimestamp(),
      "needsToChangePassword" => $this->needsToChangePassword(),
      "loginPolicy" => $loginPolicy
    ];
    $this->users[] = $user;
    $this->addCreationToJournal($user);
    return $user;
  }
  
  // 2. Parametrize what is different (in this case $role and $loginPolicy)

  public function createRegularUser($username, $password, $email) {
    // 3. Invoke the abstraction
    return $this->createUser(
      $username,
      $password,
      $email, 
      $this->regularUserRole(),
      $this->userLoginPolicy());
  }

  public function createAdminUser($username, $password, $email) {
    return $this->createUser(
      $username,
      $password,
      $email,
      $this->adminUserRole(), 
      $this->adminUserLoginPolicy());
  }
  
  // 4. Find a real-world metaphor for the abstraction
  // private function createUser(
  // $username, 
  // $password,
  // $email, 
  // $role, 
  // $loginPolicy)
}

?>
```

# Type

[X] Semi-Automatic

The steps are defined but sometimes not about text duplication, but behavior duplication.

# Safety

Since this is not a mechanical refactoring, you need good coverage on the code you modify.

# Why is the code better?

You have a single source of truth, more compact code, and an easier-to-maintain solution.

# Tags

- Coupling

# Related Refactorings

[Refactoring 002 - Extract Method](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Refactorings/Refactoring%20002%20-%20Extract%20Method/readme.md)

[Refactoring 003 - Extract Constant](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Refactorings/Refactoring%20003%20-%20Extract%20Constant/readme.md)

[Refactoring 007 - Extract Class](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Refactorings/Refactoring%20007%20-%20Extract%20Class/readme.md)

[Refactoring 010 - Extract Method Object](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Refactorings/Refactoring%20010%20-%20Extract%20Method%20Object/readme.md)

[Refactoring 014 - Remove IF](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Refactorings/Refactoring%20014%20-%20Remove%20IF/readme.md)

# Credits

Image from [Rachealmarie](https://pixabay.com/users/rachealmarie-3893509/) on [Pixabay](https://pixabay.com/)

* * * 

This article is part of the Refactoring Series.

[How to Improve Your Code With Easy Refactorings](https://github.com/mcsee/Software-Design-Articles/tree/main/Articles/Refactorings/How%20to%20Improve%20your%20Code%20With%20Easy%20Refactorings/readme.md)