Refactor this code and make it cleaner